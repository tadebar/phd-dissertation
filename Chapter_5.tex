%!TEX root = PhD_Thesis.tex
\chapter[Human-in-the-Loop Control]{Human-in-the-Loop Control of Ultrasound-Guided Needle Steering}

\section{Introduction}
The experimental results presented in Chapter 4 showed promising accuracy in autonomous targeting of the needle tip. While these tests were performed in biological tissues, they were completed in a bench-top setting, over a relatively small needle steering workspace. Early tests in a more realistic clinical environment---using a porcine cadaver in a simulated interventional radiology suite---revealed several problems preventing the direct application of our bench-top techniques. The mechanical 3D ultrasound transducer used in the previous section has limited field of view relative to the size of the liver, and any motion of the transducer invalidates all existing data. (In Section~\ref{sec:AutonomousControl} the transducer was clamped relative to the tissue sample.) External tracking systems can be used to increase the ultrasound's field of view by creating panoramic data, but this necessitates additional infrastructure. The appearance of the vibrating needle in Doppler ultrasound can be highly irregular in more realistic imaging arrangements. The Doppler approach still provides an indication of needle pose, but more sophisticated segmentation algorithms would be needed for autonomous control as in Section~\ref{sec:AutonomousControl}. Finally, visualization of 3D ultrasound data, needle pose, target location, etc. requires specialized software.

To allow closed-loop ultrasound-guided needle steering in a realistic clinical situation, we implemented our UKF estimation scheme using a different imaging approach. Specifically, we used freehand-3D ultrasound imaging, and manual localization of the steerable needle tip. 

This chapter is divided into three sections. Section~\ref{sec:HumanInTheLoopImplementation} describes the algorithmic, hardware, and software implementation of our clinical human-in-the-loop approach. Section~\ref{sec:HumanInTheLoopValidation} describes experimental validation of our human-in-the-loop control approach, in bench-top and simulated clinical testing. Section~\ref{sec:HumanInTheLoopResults} presents the results.

\section{Implementation}
\label{sec:HumanInTheLoopImplementation}

\subsection{Robot and Steerable Needles}
\label{sec:NS2RobotAndNeedle}
Chapter 3 presented a new articulated-tip steerable needle that showed promising curvature results in biological tissue. Unfortunately, as discussed in that chapter, the plastic construction of the miniature hinges failed too frequently to be used in a clinical setting. Chapter 6 discusses possible future improvements to the hinge design. In this chapter, we applied the exaggerated tip geometry suggested by the results of Chapter 3, but used a flexure tip, consisting of a rectangular Nitinol wire plastically deformed to the desired tip angle. This tip is able to pass through an introducer sheath, because of the large elastic range of Nitinol, and while returning to its bent shape inside tissue. This design does require duty cycle control to follow straight paths, and may increase tissue damage, unlike the articulated-tip needle. A similar flexure tip was previously proposed by Swaney et al.~\cite{Swaney2013}. Fig.~\ref{fig:NS2AndNeedle} shows the flexure tip steerable needle and the robot used to drive it in this chapter.

\begin{figure}[!ht]
\centering
\includegraphics[width = 0.4\columnwidth]{./Images/Chapter5/NS2RobotAndNeedle/DRAFTNS2RobotAndNeedle.jpg}%
\caption[Robot and flexure-tip steerable needles]{Portable needle steering robot with positioning arm and handle, flexure-tip steerable with integrated anti-buckling sheath and connector fitting for introducer sheath.}
\label{fig:NS2AndNeedle}
\end{figure}  

\subsection{Control Modes}
Our implementation of human-in-the-loop control allows the user to select between joint-space control of the needle steering robot and task-space control of the needle tip position. In joint-space control, the user uses a 3D mouse (SpaceNavigator; 3Dconnexion, Boston, MA) to directly control the insertion and rotation of the needle steering robot's two DOF. Using a rate-control scheme, uniaxial displacement of the 3D mouse is mapped to insertion velocity, while uniaxial rotation of the 3D mouse is mapped to rotation speed. The remaining inputs of the 3D mouse are not used. Fig.~\ref{fig:InputDevices}

\begin{figure}[!t]
\centering
\includegraphics[width = 0.4\columnwidth]{./Images/Chapter5/InputDevices/DRAFTInputDevices.jpg}%
\caption[Input devices for robot control]{Input devices for human-in-the-loop control of robotic needle steer: (a) A 3D mouse is used for rate control of the steerable needle insertion and rotation. (b) A tablet is used to select targets and measure the needle tip position in the stream of 2D ultrasound images.}
\label{fig:InputDevices}
\end{figure}  

In task-space control, the user selects target positions directly in the live 2D ultrasound image using a tablet interface (Cintiq 13; Wacom Co., Vancouver, WA. The robot then steers the needle towards the target semi-autonomously, with feedback based on the output from the UKF estimation scheme described in Chapter 4. The estimator is updated without measurement feedback (i.e., based on the process model) at the ultrasound machine's native framerate. After every 10~mm of insertion, the system requires a tip position measurement, which the user provides by scanning over the needle tip and localizing it using the tablet interface. The estimation scheme is implemented exactly as described in Chapter 4 with two exceptions. First, the process and measurement noise levels were again experimentally characterized for the flexure needle and manual measurements, and the filter gains were adjusted accordingly. Second, the manual measurements only provided feedback on tip position, so tip orientation feedback was taken directly from the output of the estimator, with extremely low gain (high variance). This approach avoided practical computational issues related to matrix inversion and manipulation.

\begin{figure}[!t]
\centering
\includegraphics[width = 0.4\columnwidth]{./Images/Chapter5/Freehand3DUS/DRAFTFreehand3DUS.jpg}%
\caption[Freehand 3D ultrasound imaging arrangement]{Freehand 3D ultrasound imaging arrangement. The ultrasound transducer with integrated tracking element and electromagnetic tracking base station are depicted, along with the corresponding coordinate frames used to reconstruct the 3D pose of the 2D ultrasound image data.}
\label{fig:freehand3DUS}
\end{figure}  

\subsection{Freehand 3D Doppler Ultrasound Imaging}
As in the previous chapters, a SonixMDP ultrasound console (Ultrasonix Medical Corp., Richmond, Canada) was used for imaging. Unlike in the previous chapters, a 2D curvilinear transducer (C5-2/60) with an integrated electromagnetic tracking element was used. Fig.~\ref{fig:freehand3DUS} depicts this arrangement. The calibrated electromagnetic tracking system, branded as SonixGPS by Ultrasonix, allows the 3D context of the 2D ultrasound image data to be resolved in real time. 

As in Chapter 2, external vibrations were applied to the proximal end of the steerable needle shaft. However, in this chapter, a spring-loaded clip was used to attach a vibration motor (a miniature DC motor spinning a small eccentric mass) to the steerable needle shaft. Fig.~\ref{fig:Buzzer} shows the new vibration device. Compared to the integrated piezoelectric buzzer described in Chapter 2, this system has the advantages that is completely disposable if contaminated with bodily fluids, and it can be visually monitored during insertion and retraction to ensure good coupling. These characteristics were identified as necessary after early cadaver testing.

\begin{figure}[!t]
\centering
\includegraphics[width = 0.4\columnwidth]{./Images/Chapter5/Buzzer/DRAFTBuzzer.jpg}%
\caption[Disposable buzzer]{Disposable buzzer for ultrasound Doppler imaging. A 3D-printed spring-loaded clip attaches a vibration motor to the steerable needle shaft. The unit is battery powered and entirely disposable.}
\label{fig:Buzzer}
\end{figure}  

\subsection{Visualization and Control Software}
A custom graphical user interface (GUI) was developed using Qt for human-in-the-loop control. The GUI is shown in Fig.~\ref{fig:GUI}. The clinician user views both a live 2D ultrasound image streamed from the SonixMDP console, as well as a live 3D visualization of the robot pose, transducer pose, estimate, and target, as defined using the SonixGPS tracker. The GUI is optimized for a tablet interface. Controls allow the user to select between the two control modes (joint-space control and task-space control). The user can also use the tablet interface to set a the target point by clicking in the live 2D ultrasound image. Measurements of the steerable needle tip's position are similarly performed by clicking in the live 2D ultrasound image. 

\begin{figure}[!t]
\centering
\includegraphics[width = 0.9\columnwidth]{./Images/Chapter5/GUI/GUI.jpg}%
\caption[Software interface]{Software interface for human-in-the-loop control. A screenshot shows the software during initial insertion of the robot, while the steerable needle tip is still within the introducer needle. Three panels are shown: (left) the live 2D ultrasound image with the current tip frame estimate over the hyperechoic needle shaft, (top right) the 3D visualization showing the ultrasound transducer pose, robot pose, tip frame estimate, and target (blue sphere), (bottom right) software control buttons and robot status readout.}
\label{fig:GUI}
\end{figure}  






\section{Experimental Validation}
\label{sec:HumanInTheLoopValidation}

\subsection{Quantification of Process and Measurement Noise}
As in Chapter 4, we first quantified process noise and measurement noise using our new robot and imaging arrangement. Process noise was again quantified by using a magnetic tracking system to precisely measure the motion of a steerable needle tip during incremental insertion along constant curvature paths. In this testing, a flexure-tip steerable needle with $l = 10$~mm and $\alpha = 45$~degrees was used. The needle was inserted along a minimum-radius-of-curvature path at a constant insertion velocity of XX mm/s, and no rotation. The pose of the needle tip after each incremental step was compared with what was expected based on the previous pose and the process model. Although the insertion increment varied slightly due to software timing, it was generally about 0.2~mm. The needle was inserted along six paths, with 617 total measurements captured. The initial tip frame orientation was defined in the robot frame based on fixture geometry and the initial joint values $\theta$ and $\l$. Radius of curvature $\rho$ for the needle was also measured using the magnetic tracking data and the least-squares fitting approach described in Chapter~3. Data analysis was performed offline using Matlab. 

Measurement noise was quantified by comparing manual tip localization results from repeated freehand-3D ultrasound scans of steerable needles in porcine liver tissue. Five repeated measurements were performed at each tip position, with 200 total measurements over five needle insertions. For each measurement, the user scanned over the needle with the ultrasound transducer, and manually selected the location of the steerable needle tip using the tablet and stylus. Data analysis was again performed offline in Matlab.

\subsection{Accuracy of Estimation Scheme}
We attempted to quantify the accuracy of our UKF estimation scheme in this application by comparison with a gold-standard measurement. This is difficult because there is no true gold-standard measurement of steerable needle tip pose (if there was, we would likely attempt to use it for closed-loop control in place of ultrasound imaging). Although an electromagnetic tracker inside the needle tip was used for quantifying process noise, there are several practical issues that limit its use as a gold-standard. First, the tracker is sensitive to electromagnetic noise from the vibration motor during actual steering. Second, the vendor-supplied calibration of the tracked ultrasound transducer is not perfectly accurate. Finally, it is impossible to place the electromagnetic transducer right at the needle tip (because of the rigid bent-tip section), so a tip calibration must be applied to the raw tracking data. This tip calibration can become inaccurate as the needle bends, and makes the measurement very sensitive to orientation noise. 

In any case, since the electromagnetic tracking system provides the best reference data, we compared our estimator with it over a series of steering trials. Over four insertions in \textit{ex vivo} porcine liver, the needle was steered while alternating between joint-space and task-space control. On each control update (synchronized to the ultrasound framerate), the calibrated electromagnetic tracker reading and UKF estimate was saved, and comparison was performed offline in Matlab.

\subsection{Clinical Needle Steering Experiments}
Fig.~\ref{fig:CadaverSetup} shows the experimental setup for the clinical needle steering experiments. A fresh pig carcass with an undisturbed liver was obtained for testing. To prevent coagulation and preserve the mechanical properties of the liver as much as possible, heparin was administered at a dosage of 300 IU/kg prior to euthanasia. The carcass was placed in supine position on a standard interventional radiology suite table, and was restrained to prevent tissue motion. 

\begin{figure}[!t]
\centering
\includegraphics[width = \columnwidth]{./Images/Chapter5/CadaverSetup/CadaverSetup.jpg}%
\caption[Clinical Needle Steering Experimental Setup]{Clinical Steering Experimental Setup. The pig carcass is mounted in supine position on the table. The needle steering robot is secured to the table rails, and connected to an introducer sheath to allow access to the liver through skin and subcutaneous fat. A second introducer sheath allows placement of target coils.}
\label{fig:CadaverSetup}
\end{figure}  

After exploratory ultrasound imaging, multi-loop-coil fiducials were implanted in the liver to serve as targets. These fiducials are designed to be visible in CT imaging, but are also visible in ultrasound because of the gas trapped in the coils.  

A second 15-gauge introducer needle was used to place each fiducial. 

The needle was left in place during steering to aid in target identification.

After implanting each target, the needle steering robot was used to place the tip of the steerable needle at the target fiducial using human-in-the-loop control. 

The steerable needle accessed the liver in an anterior subcostal approach, through a 15-gauge, XX-cm introducer needle. 

\begin{figure}[!t]
\centering
\includegraphics[width = \columnwidth]{./Images/Chapter5/CadaverTargetsUS/CadaverTargetsUS.pdf}%
\caption[Entry vector, targets and obstacles in cadaver liver]{Entry vector, targets and obstacles in cadaver liver. Three fiducials (numbered) were implanted around the gallbladder to provide targets for closed-loop needle steering. The targets were not all located within the imaging plane, and locations are approximate. The introducer needle and approximate initial path of the steerable needle are indicated, as are the gallbladder and liver boundary. }
\label{fig:CadaverSetup}
\end{figure} 




\section{Results}
\label{sec:HumanInTheLoopResults}

\subsection{Quantification of Process and Measurement Noise}
Across 517 samples of process noise, the mean position error (in millimeters) and mean orientation error (in degrees) were \[{\overline{p}_{w}} = \begin{bmatrix} 0.03 &-0.17 &0.01 \end{bmatrix}^{\text{T}}, {\overline{r}_{w}} = \begin{bmatrix} 0.18 &-0.03 &0.08 \end{bmatrix}^{\text{T}}.\] To find the best-fit zero-mean Gaussian distribution to the process noise, we again reflected the measured noise vectors, resulting in a sample covariance of
\begin{align*}
{\hat{Q}} = \begin{bmatrix} 
\phantom{-}0.16 & \phantom{-}0.02 	&-0.04 & -0.01 & \phantom{-}0.03 & \phantom{-}0.06\\
\phantom{-}0.02 & \phantom{-}0.16 & -0.02 & -0.05 & \phantom{-}0.03 & \phantom{-}0.01 \\ 
-0.04 & -0.02 & \phantom{-}0.46 & -0.10 & \phantom{-}0.01 & -0.03 \\
-0.01 & -0.05 & -0.10 & \phantom{-}0.24 & \phantom{-}0.01 & \phantom{-}0.02 \\
\phantom{-}0.03 & \phantom{-}0.03 & \phantom{-}0.01 & \phantom{-}0.01 & \phantom{-}0.05 & \phantom{-}0.03 \\
\phantom{-}0.06 & -0.01 & -0.03 & \phantom{-}0.04 & \phantom{-}0.03 & \phantom{-}0.24\\ 
\end{bmatrix}.
\end{align*}

In the measurement noise experiment, we again assumed the mean of repeated localization at each tip pose was the true needle pose.
\begin{align*}
{\hat{R}} = \begin{bmatrix} 
\phantom{-}2.29 & \phantom{-}1.58 & \phantom{-}2.51 \\ 
\phantom{-}1.58 & \phantom{-}6.97 & \phantom{-}2.19 \\ 
\phantom{-}2.51 & \phantom{-}2.19 & \phantom{-}11.4 \\ 
\end{bmatrix}.
\end{align*}

\subsection{Accuracy of Estimation Scheme}
Over 5199 data points, mean estimator error was 4.6~mm.


\begin{figure}[!t]
\centering
\includegraphics[width = \columnwidth]{./Images/Chapter5/UKFAccuracy/UKFAccuracy.pdf}%
\caption[UKF accuracy results]{UKF estimation scheme accuracy results. Comparison of calibrated and filtered electromagnetic tracker position (GPS) with estimator position (UKF). Measurements are also indicated. Robot joint variables ($\theta$, $l$) and radius of curvature $\rho$ inputs to the model are also shown. For UKF updates, $\rho$ is set to 1000~mm while the needle is inside the introducer sheath. }
\label{fig:GUI}
\end{figure}  

\subsection{Simulated Clinical Steering Experiments}
